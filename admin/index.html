<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodleGPT Admin Dashboard</title>
    <meta name="description" content="MoodleGPT Admin Dashboard - Manage users, QA database, and settings">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
        }
        header h1 { font-size: 24px; font-weight: 600; color: #fff; }
        header h1 span { color: #4f8cff; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .online-indicator {
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            background: rgba(76, 175, 80, 0.2); border-radius: 20px; font-size: 13px; color: #4caf50;
        }
        .online-indicator .dot {
            width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;
        }
        .status-badge {
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            border-radius: 20px; font-size: 13px; font-weight: 500;
        }
        .status-badge.online { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-badge.offline { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);
        }
        .card h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 12px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .stat-value.online-count { color: #4caf50; }
        .stat-label { font-size: 12px; color: #666; }
        .card.full-width { grid-column: 1 / -1; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: #4f8cff; color: #fff; }
        .btn-primary:hover { background: #3a7ae8; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-success { background: #4caf50; color: #fff; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-warning { background: #ff9800; color: #fff; }
        .btn-warning:hover { background: #f57c00; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: #888; margin-bottom: 6px; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px; background: rgba(0, 0, 0, 0.2); color: #fff; font-size: 14px; font-family: inherit;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #4f8cff; }
        .tabs {
            display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px; flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px; border: none; background: none; color: #888; cursor: pointer;
            font-size: 14px; border-radius: 8px 8px 0 0; transition: all 0.2s;
        }
        .tab:hover { color: #fff; background: rgba(255, 255, 255, 0.05); }
        .tab.active { color: #4f8cff; background: rgba(79, 140, 255, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .users-table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        th {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888;
            font-weight: 500; position: sticky; top: 0; background: #1a1a2e;
        }
        td { font-size: 13px; }
        tr:hover { background: rgba(255, 255, 255, 0.02); }
        tr.user-online { background: rgba(76, 175, 80, 0.05); }
        tr.user-blocked { background: rgba(244, 67, 54, 0.05); }
        .user-id {
            font-family: 'Consolas', monospace; background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px; border-radius: 4px; font-size: 11px; max-width: 200px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block;
        }
        .user-name { font-weight: 500; color: #fff; }
        .user-name-editable { cursor: pointer; border-bottom: 1px dashed rgba(255,255,255,0.3); }
        .user-name-editable:hover { color: #4f8cff; }
        .online-badge {
            display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
            border-radius: 10px; font-size: 11px; font-weight: 500;
        }
        .online-badge.online { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .online-badge.offline { background: rgba(158, 158, 158, 0.2); color: #9e9e9e; }
        .blocked-badge {
            display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 11px;
            font-weight: 500; background: rgba(244, 67, 54, 0.2); color: #f44336; margin-left: 5px;
        }
        .premium-badge {
            display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 11px;
            font-weight: 500; background: rgba(255, 193, 7, 0.2); color: #ffc107; margin-left: 5px;
        }
        .stripe-badge {
            display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 11px;
            font-weight: 500; background: rgba(99, 91, 255, 0.2); color: #635bff; margin-left: 5px;
        }
        .action-btn {
            background: none; border: none; padding: 6px 10px; border-radius: 4px;
            cursor: pointer; transition: all 0.2s; font-size: 12px;
        }
        .action-btn.block { color: #f44336; }
        .action-btn.block:hover { background: rgba(244, 67, 54, 0.2); }
        .action-btn.unblock { color: #4caf50; }
        .action-btn.unblock:hover { background: rgba(76, 175, 80, 0.2); }
        .action-btn.edit { color: #4f8cff; }
        .action-btn.edit:hover { background: rgba(79, 140, 255, 0.2); }
        .action-btn.delete { color: #f44336; }
        .action-btn.delete:hover { background: rgba(244, 67, 54, 0.2); }
        .search-box { margin-bottom: 15px; }
        .search-box input {
            width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px; background: rgba(0, 0, 0, 0.2); color: #fff; font-size: 14px;
        }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-btn {
            padding: 6px 14px; border: 1px solid rgba(255,255,255,0.1); background: none;
            color: #888; border-radius: 20px; cursor: pointer; font-size: 12px; transition: all 0.2s;
        }
        .filter-btn:hover { border-color: #4f8cff; color: #4f8cff; }
        .filter-btn.active { background: rgba(79, 140, 255, 0.2); border-color: #4f8cff; color: #4f8cff; }
        .time-ago { color: #666; font-size: 12px; }
        .log-container {
            background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; max-height: 300px;
            overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.6;
        }
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .log-entry:last-child { border-bottom: none; }
        .log-entry.info { color: #4f8cff; }
        .log-entry.success { color: #4caf50; }
        .log-entry.warning { color: #ff9800; }
        .log-entry.error { color: #f44336; }
        .log-time { color: #666; margin-right: 10px; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;
            padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; color: #fff; }
        .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .user-detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); flex-wrap: wrap; }
        .user-detail-label { color: #888; font-size: 13px; }
        .user-detail-value { color: #fff; font-size: 13px; font-family: 'Consolas', monospace; word-break: break-all; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-group label { font-size: 14px; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state p { font-size: 14px; }
        .qa-list { max-height: 400px; overflow-y: auto; }
        .qa-item { padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin-bottom: 10px; position: relative; cursor: pointer; transition: all 0.2s; }
        .qa-item:hover { background: rgba(79, 140, 255, 0.1); }
        .qa-question { font-weight: 500; margin-bottom: 8px; color: #fff; }
        .qa-answer { color: #4caf50; font-size: 14px; }
        .qa-item-actions { position: absolute; top: 10px; right: 10px; display: none; gap: 5px; }
        .qa-item:hover .qa-item-actions { display: flex; }
        .qa-index { font-size: 10px; color: #666; position: absolute; bottom: 5px; right: 10px; }
        .config-display { background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin-top: 10px; }
        .config-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); flex-wrap: wrap; }
        .config-item:last-child { border-bottom: none; }
        .config-key { color: #888; font-size: 13px; }
        .config-value { color: #fff; font-family: 'Consolas', monospace; font-size: 13px; word-break: break-all; }
        /* Pending Review Styles */
        .pending-list { max-height: 500px; overflow-y: auto; }
        .pending-item {
            background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;
        }
        .pending-item:hover { background: rgba(255, 193, 7, 0.15); border-color: rgba(255, 193, 7, 0.5); }
        .pending-question { font-weight: 500; color: #fff; margin-bottom: 8px; line-height: 1.4; }
        .pending-answer { color: #ffc107; font-size: 13px; margin-bottom: 10px; }
        .pending-meta { display: flex; gap: 15px; font-size: 11px; color: #888; flex-wrap: wrap; }
        .pending-actions { display: flex; gap: 8px; margin-top: 10px; }
        .pending-actions .btn { padding: 6px 12px; font-size: 11px; }
        /* Live Mode Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .3s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: #4caf50; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .live-mode-notice { background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.4); border-radius: 8px; padding: 12px 15px; margin-bottom: 15px; color: #4caf50; font-size: 13px; }
        /* Reconciliation Modal */
        .reconciliation-modal { max-width: 900px; }
        .reconciliation-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .recon-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        .recon-panel h4 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 12px; }
        .recon-panel.pending { border: 2px solid rgba(255, 193, 7, 0.3); }
        .recon-panel.matches { border: 2px solid rgba(76, 175, 80, 0.3); }
        .recon-field { margin-bottom: 12px; }
        .recon-field label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
        .recon-field .value { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; font-size: 13px; line-height: 1.4; color: #fff; }
        .recon-field textarea, .recon-field input[type="text"] { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #404040; color: #fff; padding: 10px; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .recon-field textarea { min-height: 100px; resize: vertical; }
        .recon-field textarea:focus, .recon-field input[type="text"]:focus { outline: none; border-color: #4f8cff; }
        .match-list { max-height: 300px; overflow-y: auto; }
        .match-item {
            background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .match-item:hover { background: rgba(76, 175, 80, 0.2); }
        .match-item.selected { border-color: #4f8cff; background: rgba(79, 140, 255, 0.2); }
        .match-score { font-size: 10px; color: #4caf50; margin-bottom: 5px; }
        .match-question { font-size: 12px; color: #fff; margin-bottom: 4px; }
        .match-answer { font-size: 11px; color: #4caf50; }
        .no-matches { text-align: center; padding: 30px; color: #666; }
        /* Options List Styles */
        .options-list { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
        .option-item { padding: 8px 12px; background: #2d2d2d; border: 1px solid #404040; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .option-item:hover { background: #3d3d3d; border-color: #4CAF50; }
        .option-item.selected { background: rgba(76, 175, 80, 0.2); border-color: #4CAF50; }
        .option-item .option-letter { color: #4CAF50; font-weight: bold; margin-right: 8px; }
        .option-item .option-text { color: #e0e0e0; }
        /* Merge Styles */
        .merge-container { display: flex; gap: 20px; align-items: stretch; flex-wrap: wrap; }
        .merge-panel { flex: 1; min-width: 200px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        .merge-panel h4 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 12px; }
        .merge-arrow { display: flex; align-items: center; font-size: 24px; color: #4f8cff; }
        .merge-user-info { font-size: 13px; line-height: 1.8; }
        .merge-user-info .label { color: #888; }
        .merge-user-info .value { color: #fff; font-family: 'Consolas', monospace; word-break: break-all; }
        .merge-preview-content { background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px; font-size: 13px; }
        /* API URL Config */
        .api-config { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .api-config h4 { color: #ffc107; margin-bottom: 10px; font-size: 14px; }
        @media (max-width: 768px) {
            .reconciliation-container { grid-template-columns: 1fr; }
            .merge-arrow { transform: rotate(90deg); justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- API Configuration Banner -->
        <div class="api-config" id="apiConfigBanner">
            <h4>‚öôÔ∏è Configure API Endpoint</h4>
            <div class="input-group" style="margin-bottom: 10px;">
                <input type="text" id="apiUrlInput" placeholder="https://your-worker.your-subdomain.workers.dev" value="">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="saveApiUrl()">Save & Connect</button>
                <button class="btn btn-secondary btn-sm" onclick="hideApiConfig()">Hide</button>
            </div>
        </div>

        <header>
            <h1>üéì Moodle<span>GPT</span> Admin</h1>
            <div class="header-right">
                <div class="online-indicator">
                    <span class="dot"></span>
                    <span id="onlineCount">0</span> online now
                </div>
                <div class="status-badge offline" id="serverStatus">
                    <span class="status-dot"></span>
                    <span id="statusText">Offline</span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="showApiConfig()">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <h2>üë• Total Users</h2>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Registered users</div>
            </div>
            <div class="card">
                <h2>üü¢ Online Now</h2>
                <div class="stat-value online-count" id="onlineUsers">0</div>
                <div class="stat-label">Active in last 2 min</div>
            </div>
            <div class="card">
                <h2>üìö QA Entries</h2>
                <div class="stat-value" id="qaCount">0</div>
                <div class="stat-label">Questions in database</div>
            </div>
            <div class="card">
                <h2>üì• Pending</h2>
                <div class="stat-value" id="pendingStatCount" style="color: #ffc107;">0</div>
                <div class="stat-label">Awaiting review</div>
            </div>
            <div class="card">
                <h2>üö´ Blocked</h2>
                <div class="stat-value" id="blockedCount">0</div>
                <div class="stat-label">Users restricted</div>
            </div>
        </div>

        <div class="card full-width">
            <div class="tabs">
                <button class="tab active" data-tab="users">üë• Users</button>
                <button class="tab" data-tab="online">üü¢ Online Now</button>
                <button class="tab" data-tab="pending">üì• Pending Review</button>
                <button class="tab" data-tab="qa">üìö QA Database</button>
                <button class="tab" data-tab="config">‚öôÔ∏è Configuration</button>
                <button class="tab" data-tab="logs">üìã Logs</button>
            </div>

            <div class="tab-content active" id="tab-users">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="üîç Search by name, email, or Stripe ID...">
                </div>
                <div class="filter-row">
                    <button class="filter-btn active" data-filter="all">All Users</button>
                    <button class="filter-btn" data-filter="online">Online</button>
                    <button class="filter-btn" data-filter="blocked">Blocked</button>
                    <button class="filter-btn" data-filter="premium">Premium</button>
                    <button class="filter-btn" data-filter="stripe">Stripe Users</button>
                    <span style="margin-left: auto; color: #666; font-size: 12px;">
                        <span id="filteredCount">0</span> users shown
                    </span>
                </div>
                <div class="users-table-container" style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Name</th>
                                <th>Identifier</th>
                                <th>First Seen</th>
                                <th>Last Active</th>
                                <th>Requests</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" class="empty-state"><p>No users registered yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="tab-online">
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="refreshOnlineUsers()">üîÑ Refresh</button>
                </div>
                <div id="onlineUsersList">
                    <div class="empty-state"><p>No users online right now</p></div>
                </div>
            </div>

            <div class="tab-content" id="tab-pending">
                <div class="btn-group" style="margin-bottom: 15px; align-items: center;">
                    <button class="btn btn-primary" onclick="fetchFromSheets()">üì• Fetch from Google Sheets</button>
                    <button class="btn btn-secondary" onclick="refreshPending()">üîÑ Refresh</button>
                    <div class="live-mode-toggle" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                        <span style="color: #888; font-size: 12px;">Live Mode:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="liveModeToggle" onchange="toggleLiveMode()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="liveModeStatus" style="font-size: 12px; color: #888;">OFF</span>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="clearAllPending()">Clear All</button>
                    <span style="margin-left: 15px; color: #888; font-size: 12px;"><span id="pendingCount">0</span> pending</span>
                </div>
                <div id="liveModeNotice" class="live-mode-notice" style="display: none;">
                    ‚ö° <strong>Live Mode Active</strong> - Pending questions are being served to all users with AI answers.
                </div>
                <div class="pending-list" id="pendingList">
                    <div class="empty-state"><p>No pending entries. Click "Fetch from Google Sheets" to import Q&A submissions.</p></div>
                </div>
            </div>

            <div class="tab-content" id="tab-qa">
                <div class="search-box">
                    <input type="text" id="qaSearchInput" placeholder="üîç Search questions...">
                </div>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showAddQAModal()">+ Add Question</button>
                    <button class="btn btn-secondary" onclick="refreshQA()">Refresh</button>
                    <button class="btn btn-secondary" onclick="exportQA()">Export JSON</button>
                </div>
                <div class="qa-list" id="qaList">
                    <div class="empty-state"><p>No QA entries loaded</p></div>
                </div>
            </div>

            <div class="tab-content" id="tab-config">
                <div class="input-group">
                    <label>Cloudflare Worker API URL</label>
                    <input type="text" id="workerUrlDisplay" readonly style="background: rgba(0,0,0,0.4);">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                    <button class="btn btn-secondary" onclick="showApiConfig()">Change API URL</button>
                </div>
                <div class="config-display" style="margin-top: 20px;">
                    <div class="config-item">
                        <span class="config-key">Storage Backend</span>
                        <span class="config-value">GitHub (via Cloudflare Worker)</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">User Identification</span>
                        <span class="config-value">Stripe Email / Customer ID</span>
                    </div>
                    <div class="config-item">
                        <span class="config-key">Dashboard Version</span>
                        <span class="config-value">3.0.0 (GitHub Pages)</span>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-logs">
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info"><span class="log-time">[--:--:--]</span> Dashboard initialized</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div id="userModalContent"></div>
        </div>
    </div>

    <!-- Add QA Modal -->
    <div class="modal" id="addQAModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Question</h3>
                <button class="modal-close" onclick="closeModal('addQAModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Question</label>
                <textarea id="newQAQuestion" placeholder="Enter the question text..." style="min-height: 100px;"></textarea>
            </div>
            <div class="input-group">
                <label>Answer</label>
                <input type="text" id="newQAAnswer" placeholder="Enter the correct answer">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveNewQA()">Add Question</button>
                <button class="btn btn-secondary" onclick="closeModal('addQAModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit QA Modal -->
    <div class="modal" id="editQAModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit QA Entry</h3>
                <button class="modal-close" onclick="closeModal('editQAModal')">&times;</button>
            </div>
            <input type="hidden" id="editQAIndex">
            <div class="input-group">
                <label>Question</label>
                <textarea id="editQAQuestion" style="min-height: 100px;"></textarea>
            </div>
            <div class="input-group">
                <label>Answer</label>
                <input type="text" id="editQAAnswer">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveEditedQA()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal('editQAModal')">Cancel</button>
                <button class="btn btn-danger" onclick="deleteQAEntry()" style="margin-left: auto;">Delete</button>
            </div>
        </div>
    </div>

    <!-- User Merge Modal -->
    <div class="modal" id="mergeModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üîÄ Merge Users</h3>
                <button class="modal-close" onclick="closeModal('mergeModal')">&times;</button>
            </div>
            <p style="color: #888; margin-bottom: 20px;">Select another user to merge into this one. The selected user will be deleted and their data combined.</p>
            <div class="merge-container">
                <div class="merge-panel">
                    <h4>Primary User (Keep)</h4>
                    <input type="hidden" id="mergePrimaryId">
                    <div id="mergePrimaryInfo" class="merge-user-info"></div>
                </div>
                <div class="merge-arrow">‚ûú</div>
                <div class="merge-panel">
                    <h4>Merge From (Delete)</h4>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <select id="mergeSecondarySelect" onchange="updateMergePreview()">
                            <option value="">Select a user to merge...</option>
                        </select>
                    </div>
                    <div id="mergeSecondaryInfo" class="merge-user-info"></div>
                </div>
            </div>
            <div id="mergePreview" style="margin-top: 20px; display: none;">
                <h4 style="color: #4caf50; margin-bottom: 10px;">üìã Merge Preview</h4>
                <div class="merge-preview-content"></div>
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-warning" onclick="executeMerge()" id="executeMergeBtn" disabled>üîÄ Merge Users</button>
                <button class="btn btn-secondary" onclick="closeModal('mergeModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reconciliation Modal -->
    <div class="modal" id="reconcileModal">
        <div class="modal-content reconciliation-modal">
            <div class="modal-header">
                <h3>üîÑ Reconcile Entry</h3>
                <button class="modal-close" onclick="closeModal('reconcileModal')">&times;</button>
            </div>
            <div class="reconciliation-container">
                <div class="recon-panel pending">
                    <h4>üì• Pending Entry</h4>
                    <input type="hidden" id="reconPendingId">
                    <div class="recon-field">
                        <label>Question</label>
                        <textarea id="reconQuestion" class="value"></textarea>
                    </div>
                    <div class="recon-field">
                        <label>Answer</label>
                        <input type="text" id="reconAnswer" class="value">
                    </div>
                    <div class="recon-field" id="reconOptionsContainer" style="display: none;">
                        <label>üìã Available Options</label>
                        <div id="reconOptionsList" class="options-list"></div>
                    </div>
                    <div class="recon-field">
                        <label>Source</label>
                        <div class="value" id="reconSource">-</div>
                    </div>
                </div>
                <div class="recon-panel matches">
                    <h4>üîç Similar Existing Entries</h4>
                    <div class="search-box" style="margin-bottom: 10px;">
                        <input type="text" id="reconSearchInput" placeholder="Search for matches..." onkeyup="searchForMatches()">
                    </div>
                    <div class="match-list" id="matchList">
                        <div class="no-matches">Searching for similar entries...</div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="approveAsPending()">‚úì Approve as New</button>
                <button class="btn btn-primary" onclick="mergeWithSelected()" id="mergeBtn" disabled>üîÄ Merge with Selected</button>
                <button class="btn btn-danger" onclick="rejectPending()">‚úó Reject</button>
                <button class="btn btn-secondary" onclick="closeModal('reconcileModal')" style="margin-left: auto;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Default to Cloudflare Worker (no local server needed!)
        const DEFAULT_WORKER_URL = 'https://moodlegpt-unified-api.mgpt3.workers.dev';
        let API_URL = localStorage.getItem('moodlegpt_api_url') || DEFAULT_WORKER_URL;
        let users = [], qaData = [], pendingData = [], currentFilter = 'all', currentSearch = '', logs = [];
        let selectedMatchIndex = null, currentPendingId = null, liveModeEnabled = false;
        let mergePrimaryUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            initFilters();
            initSearch();
            
            // Always connect - we have a default Worker URL now
            document.getElementById('apiConfigBanner').style.display = 'none';
            document.getElementById('workerUrlDisplay').value = API_URL;
            refreshAllData();
            setInterval(refreshAllData, 15000);
            
            addLog('Dashboard initialized (Cloudflare Worker mode)', 'info');
            addLog(`API URL: ${API_URL}`, 'info');
        });

        // API Configuration
        function showApiConfig() {
            document.getElementById('apiConfigBanner').style.display = 'block';
            document.getElementById('apiUrlInput').value = API_URL;
        }

        function hideApiConfig() {
            if (API_URL) {
                document.getElementById('apiConfigBanner').style.display = 'none';
            }
        }

        function saveApiUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (!url) {
                alert('Please enter a valid API URL');
                return;
            }
            API_URL = url.replace(/\/$/, ''); // Remove trailing slash
            localStorage.setItem('moodlegpt_api_url', API_URL);
            document.getElementById('workerUrlDisplay').value = API_URL;
            document.getElementById('apiConfigBanner').style.display = 'none';
            addLog(`API URL configured: ${API_URL}`, 'success');
            refreshAllData();
        }

        // Tab Management
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        function initFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderUsers();
                });
            });
        }

        function initSearch() {
            document.getElementById('userSearch').addEventListener('input', (e) => {
                currentSearch = e.target.value.toLowerCase();
                renderUsers();
            });
            document.getElementById('qaSearchInput').addEventListener('input', (e) => {
                renderQAList(e.target.value);
            });
        }

        // Logging
        function addLog(message, type = 'info') {
            const time = new Date().toTimeString().split(' ')[0];
            logs.push({ time, message, type });
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            container.insertBefore(entry, container.firstChild);
            while (container.children.length > 100) container.removeChild(container.lastChild);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // API Helpers
        async function apiCall(endpoint, method = 'GET', body = null) {
            if (!API_URL) {
                throw new Error('API URL not configured');
            }
            
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_URL}${endpoint}`, options);
            const result = await response.json();
            
            if (!result.success && result.error) {
                throw new Error(result.error);
            }
            
            return result;
        }

        // Server Status
        async function checkServerStatus() {
            try {
                const result = await apiCall('/api/health');
                if (result.success) {
                    setServerStatus('online', 'Online');
                    return true;
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
            setServerStatus('offline', 'Offline');
            return false;
        }

        function setServerStatus(status, text) {
            document.getElementById('serverStatus').className = `status-badge ${status}`;
            document.getElementById('statusText').textContent = text;
        }

        // Data Refresh
        async function refreshAllData() {
            try {
                if (await checkServerStatus()) {
                    await Promise.all([refreshUsers(), refreshQA(), refreshPending(), checkLiveModeStatus()]);
                }
            } catch (e) {
                console.error('Refresh error:', e);
                addLog(`Refresh error: ${e.message}`, 'error');
            }
        }

        // Users
        async function refreshUsers() {
            try {
                const result = await apiCall('/api/users');
                if (result.success) {
                    users = result.data.users || [];
                    document.getElementById('totalUsers').textContent = result.data.total || 0;
                    document.getElementById('onlineUsers').textContent = result.data.online_count || 0;
                    document.getElementById('onlineCount').textContent = result.data.online_count || 0;
                    document.getElementById('blockedCount').textContent = users.filter(u => u.blocked).length;
                    renderUsers();
                    renderOnlineUsers();
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            let filtered = users.filter(user => {
                if (currentFilter === 'online' && !user.online) return false;
                if (currentFilter === 'blocked' && !user.blocked) return false;
                if (currentFilter === 'premium' && !user.settings?.premium) return false;
                if (currentFilter === 'stripe' && (!user.identity?.stripe_customer_id && !user.identity?.email)) return false;
                if (currentSearch) {
                    const searchStr = `${user.name} ${user.id} ${user.identity?.email || ''} ${user.identity?.stripe_customer_id || ''}`.toLowerCase();
                    return searchStr.includes(currentSearch);
                }
                return true;
            });
            document.getElementById('filteredCount').textContent = filtered.length;
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><p>No users match the current filter</p></td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(user => {
                const isStripeUser = user.identity?.stripe_customer_id || (user.identity?.source === 'stripe');
                const displayId = user.identity?.email || user.identity?.stripe_customer_id || user.id;
                return `
                <tr class="${user.blocked ? 'user-blocked' : (user.online ? 'user-online' : '')}">
                    <td>
                        ${user.online ? '<span class="online-badge online">‚óè Online</span>' : '<span class="online-badge offline">‚óã Offline</span>'}
                        ${user.blocked ? '<span class="blocked-badge">üö´ Blocked</span>' : ''}
                        ${user.settings?.premium ? '<span class="premium-badge">‚≠ê Premium</span>' : ''}
                        ${isStripeUser ? '<span class="stripe-badge">üí≥ Stripe</span>' : ''}
                    </td>
                    <td><span class="user-name user-name-editable" onclick="editUser('${encodeURIComponent(user.id)}')">${escapeHtml(user.name || 'Unknown')}</span></td>
                    <td><span class="user-id" title="${escapeHtml(user.id)}">${escapeHtml(displayId.substring(0, 30))}${displayId.length > 30 ? '...' : ''}</span></td>
                    <td class="time-ago">${formatDate(user.first_seen)}</td>
                    <td class="time-ago">${formatTimeAgo(user.last_seen)}</td>
                    <td>${user.total_requests || 0}</td>
                    <td>
                        <button class="action-btn edit" onclick="editUser('${encodeURIComponent(user.id)}')" title="Edit">‚úèÔ∏è</button>
                        ${user.blocked 
                            ? `<button class="action-btn unblock" onclick="toggleBlock('${encodeURIComponent(user.id)}', false)" title="Unblock">‚úì</button>`
                            : `<button class="action-btn block" onclick="toggleBlock('${encodeURIComponent(user.id)}', true)" title="Block">üö´</button>`}
                        <button class="action-btn delete" onclick="deleteUser('${encodeURIComponent(user.id)}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');
        }

        function renderOnlineUsers() {
            const container = document.getElementById('onlineUsersList');
            const onlineList = users.filter(u => u.online);
            if (onlineList.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No users online right now</p></div>';
                return;
            }
            container.innerHTML = `<table><thead><tr><th>Name</th><th>Identifier</th><th>Last Activity</th><th>Actions</th></tr></thead><tbody>
                ${onlineList.map(user => `
                    <tr>
                        <td><span class="user-name">${escapeHtml(user.name || 'Unknown')}</span></td>
                        <td><span class="user-id">${escapeHtml((user.identity?.email || user.id).substring(0, 25))}...</span></td>
                        <td class="time-ago">${formatTimeAgo(user.last_seen)}</td>
                        <td>
                            <button class="action-btn edit" onclick="editUser('${encodeURIComponent(user.id)}')">‚úèÔ∏è</button>
                            <button class="action-btn block" onclick="toggleBlock('${encodeURIComponent(user.id)}', true)">üö´</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody></table>`;
        }

        async function refreshOnlineUsers() { await refreshUsers(); addLog('Online users refreshed', 'info'); }

        function editUser(encodedUserId) {
            const userId = decodeURIComponent(encodedUserId);
            const user = users.find(u => u.id === userId);
            if (!user) return;
            const content = document.getElementById('userModalContent');
            content.innerHTML = `
                <div class="user-detail-row"><span class="user-detail-label">User ID</span><span class="user-detail-value">${escapeHtml(user.id)}</span></div>
                ${user.identity?.email ? `<div class="user-detail-row"><span class="user-detail-label">Email</span><span class="user-detail-value">${escapeHtml(user.identity.email)}</span></div>` : ''}
                ${user.identity?.stripe_customer_id ? `<div class="user-detail-row"><span class="user-detail-label">Stripe Customer ID</span><span class="user-detail-value">${escapeHtml(user.identity.stripe_customer_id)}</span></div>` : ''}
                <div class="user-detail-row"><span class="user-detail-label">Identity Source</span><span class="user-detail-value">${escapeHtml(user.identity?.source || 'unknown')}</span></div>
                <div class="user-detail-row"><span class="user-detail-label">First Seen</span><span class="user-detail-value">${user.first_seen ? new Date(user.first_seen).toLocaleString() : 'N/A'}</span></div>
                <div class="user-detail-row"><span class="user-detail-label">Last Active</span><span class="user-detail-value">${user.last_seen ? new Date(user.last_seen).toLocaleString() : 'N/A'}</span></div>
                <div class="user-detail-row"><span class="user-detail-label">Total Requests</span><span class="user-detail-value">${user.total_requests || 0}</span></div>
                <div class="user-detail-row"><span class="user-detail-label">IPs Used</span><span class="user-detail-value">${(user.ips || []).join(', ') || 'None'}</span></div>
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                <div class="input-group"><label>Display Name</label><input type="text" id="editUserName" value="${escapeHtml(user.name || '')}"></div>
                <div class="input-group"><label>Notes</label><textarea id="editUserNotes" style="min-height: 80px;">${escapeHtml(user.notes || '')}</textarea></div>
                <div class="checkbox-group"><input type="checkbox" id="editUserBlocked" ${user.blocked ? 'checked' : ''}><label for="editUserBlocked">üö´ Blocked (user cannot use extension)</label></div>
                <div class="checkbox-group"><input type="checkbox" id="editUserPremium" ${user.settings?.premium ? 'checked' : ''}><label for="editUserPremium">‚≠ê Premium User</label></div>
                <div class="input-group"><label>Custom Message (shown to user)</label><input type="text" id="editUserMessage" value="${escapeHtml(user.settings?.custom_message || '')}" placeholder="Optional message"></div>
                <input type="hidden" id="editUserId" value="${escapeHtml(user.id)}">
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                    <button class="btn btn-warning" onclick="openMergeModal('${encodeURIComponent(user.id)}')" style="margin-left: auto;">üîÄ Merge</button>
                    <button class="btn btn-danger" onclick="deleteUser('${encodeURIComponent(user.id)}')">Delete</button>
                </div>
            `;
            document.getElementById('userModal').classList.add('active');
        }

        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const data = {
                user_id: userId,
                name: document.getElementById('editUserName').value.trim(),
                notes: document.getElementById('editUserNotes').value.trim(),
                blocked: document.getElementById('editUserBlocked').checked,
                settings: {
                    premium: document.getElementById('editUserPremium').checked,
                    custom_message: document.getElementById('editUserMessage').value.trim()
                }
            };
            try {
                await apiCall('/api/users/update', 'POST', data);
                addLog(`User ${userId} updated`, 'success');
                closeModal('userModal');
                await refreshUsers();
            } catch (e) {
                addLog(`Failed to update user: ${e.message}`, 'error');
            }
        }

        async function toggleBlock(encodedUserId, block) {
            const userId = decodeURIComponent(encodedUserId);
            try {
                await apiCall('/api/users/update', 'POST', { user_id: userId, blocked: block });
                addLog(`User ${userId} ${block ? 'blocked' : 'unblocked'}`, block ? 'warning' : 'success');
                await refreshUsers();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        async function deleteUser(encodedUserId) {
            const userId = decodeURIComponent(encodedUserId);
            if (!confirm(`Delete user "${userId}"? This cannot be undone.`)) return;
            try {
                await apiCall(`/api/users/${encodeURIComponent(userId)}`, 'DELETE');
                addLog(`User ${userId} deleted`, 'warning');
                closeModal('userModal');
                await refreshUsers();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        // User Merge
        function openMergeModal(encodedPrimaryId) {
            const primaryId = decodeURIComponent(encodedPrimaryId);
            mergePrimaryUser = users.find(u => u.id === primaryId);
            if (!mergePrimaryUser) return;
            closeModal('userModal');
            document.getElementById('mergePrimaryId').value = primaryId;
            document.getElementById('mergePrimaryInfo').innerHTML = formatUserInfo(mergePrimaryUser);
            const select = document.getElementById('mergeSecondarySelect');
            select.innerHTML = '<option value="">Select a user to merge...</option>' +
                users.filter(u => u.id !== primaryId)
                    .map(u => `<option value="${escapeHtml(u.id)}">${escapeHtml(u.name || 'Unknown')} (${escapeHtml((u.identity?.email || u.id).substring(0, 25))})</option>`)
                    .join('');
            document.getElementById('mergeSecondaryInfo').innerHTML = '<p style="color: #666;">Select a user from the dropdown above</p>';
            document.getElementById('mergePreview').style.display = 'none';
            document.getElementById('executeMergeBtn').disabled = true;
            document.getElementById('mergeModal').classList.add('active');
        }

        function formatUserInfo(user) {
            return `
                <div><span class="label">ID:</span> <span class="value">${escapeHtml(user.id.substring(0, 40))}${user.id.length > 40 ? '...' : ''}</span></div>
                <div><span class="label">Name:</span> <span class="value">${escapeHtml(user.name || 'Unknown')}</span></div>
                ${user.identity?.email ? `<div><span class="label">Email:</span> <span class="value">${escapeHtml(user.identity.email)}</span></div>` : ''}
                <div><span class="label">First Seen:</span> <span class="value">${user.first_seen ? new Date(user.first_seen).toLocaleDateString() : 'N/A'}</span></div>
                <div><span class="label">Requests:</span> <span class="value">${user.total_requests || 0}</span></div>
            `;
        }

        function updateMergePreview() {
            const secondaryId = document.getElementById('mergeSecondarySelect').value;
            if (!secondaryId) {
                document.getElementById('mergeSecondaryInfo').innerHTML = '<p style="color: #666;">Select a user from the dropdown above</p>';
                document.getElementById('mergePreview').style.display = 'none';
                document.getElementById('executeMergeBtn').disabled = true;
                return;
            }
            const secondaryUser = users.find(u => u.id === secondaryId);
            if (!secondaryUser) return;
            document.getElementById('mergeSecondaryInfo').innerHTML = formatUserInfo(secondaryUser);
            const mergedRequests = (mergePrimaryUser.total_requests || 0) + (secondaryUser.total_requests || 0);
            document.querySelector('#mergePreview .merge-preview-content').innerHTML = `
                <div><strong>Combined Requests:</strong> ${mergedRequests}</div>
                <div style="margin-top: 10px; color: #ff9800;">‚ö†Ô∏è User will be deleted after merge</div>
            `;
            document.getElementById('mergePreview').style.display = 'block';
            document.getElementById('executeMergeBtn').disabled = false;
        }

        async function executeMerge() {
            const primaryId = document.getElementById('mergePrimaryId').value;
            const secondaryId = document.getElementById('mergeSecondarySelect').value;
            if (!primaryId || !secondaryId) return;
            if (!confirm(`Merge users? The secondary user will be deleted.`)) return;
            try {
                await apiCall('/api/users/merge', 'POST', { primaryId, secondaryId });
                addLog(`Merged users successfully`, 'success');
                closeModal('mergeModal');
                await refreshUsers();
            } catch (e) {
                addLog(`Merge error: ${e.message}`, 'error');
            }
        }

        // QA Database
        async function refreshQA() {
            try {
                const result = await apiCall('/api/qa');
                if (result.success) {
                    qaData = result.data.qa || [];
                    document.getElementById('qaCount').textContent = qaData.length;
                    renderQAList();
                }
            } catch (e) {
                console.error('Failed to load QA:', e);
            }
        }

        function renderQAList(filter = '') {
            const container = document.getElementById('qaList');
            const filtered = filter ? qaData.filter(q => q.question?.toLowerCase().includes(filter.toLowerCase()) || q.answer?.toString().toLowerCase().includes(filter.toLowerCase())) : qaData;
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No QA entries found</p></div>';
                return;
            }
            container.innerHTML = filtered.slice(0, 100).map((qa, idx) => {
                const realIndex = qaData.indexOf(qa);
                return `
                <div class="qa-item" onclick="editQAEntry(${realIndex})">
                    <div class="qa-item-actions">
                        <button class="action-btn edit" onclick="event.stopPropagation(); editQAEntry(${realIndex})">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="event.stopPropagation(); deleteQAByIndex(${realIndex})">üóëÔ∏è</button>
                    </div>
                    <div class="qa-question">${escapeHtml(qa.question?.substring(0, 200) || 'No question')}${qa.question?.length > 200 ? '...' : ''}</div>
                    <div class="qa-answer">‚úì ${escapeHtml(Array.isArray(qa.answer) ? qa.answer.join(', ') : qa.answer?.toString() || 'No answer')}</div>
                    <div class="qa-index">#${realIndex}</div>
                </div>
            `}).join('');
        }

        function editQAEntry(index) {
            const qa = qaData[index];
            if (!qa) return;
            document.getElementById('editQAIndex').value = index;
            document.getElementById('editQAQuestion').value = qa.question || '';
            document.getElementById('editQAAnswer').value = Array.isArray(qa.answer) ? qa.answer.join(', ') : qa.answer || '';
            document.getElementById('editQAModal').classList.add('active');
        }

        async function saveEditedQA() {
            const index = parseInt(document.getElementById('editQAIndex').value);
            const question = document.getElementById('editQAQuestion').value.trim();
            const answer = document.getElementById('editQAAnswer').value.trim();
            if (!question || !answer) { alert('Please fill in both fields'); return; }
            try {
                await apiCall(`/api/qa/${index}`, 'PUT', { question, answer });
                addLog(`Updated QA entry #${index}`, 'success');
                closeModal('editQAModal');
                await refreshQA();
            } catch (e) {
                addLog(`Failed to update: ${e.message}`, 'error');
            }
        }

        async function deleteQAEntry() {
            const index = parseInt(document.getElementById('editQAIndex').value);
            if (!confirm(`Delete QA entry #${index}?`)) return;
            await deleteQAByIndex(index);
            closeModal('editQAModal');
        }

        async function deleteQAByIndex(index) {
            try {
                await apiCall(`/api/qa/${index}`, 'DELETE');
                addLog(`Deleted QA entry #${index}`, 'warning');
                await refreshQA();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        function showAddQAModal() {
            document.getElementById('newQAQuestion').value = '';
            document.getElementById('newQAAnswer').value = '';
            document.getElementById('addQAModal').classList.add('active');
        }

        async function saveNewQA() {
            const question = document.getElementById('newQAQuestion').value.trim();
            const answer = document.getElementById('newQAAnswer').value.trim();
            if (!question || !answer) { alert('Please fill in both fields'); return; }
            try {
                await apiCall('/api/qa/add', 'POST', { question, answer });
                addLog('Added new QA entry', 'success');
                closeModal('addQAModal');
                await refreshQA();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        function exportQA() {
            const blob = new Blob([JSON.stringify(qaData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `QA-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addLog(`Exported ${qaData.length} QA entries`, 'info');
        }

        // Pending Review
        async function refreshPending() {
            try {
                const result = await apiCall('/api/pending');
                if (result.success) {
                    pendingData = result.data.pending || [];
                    document.getElementById('pendingCount').textContent = pendingData.length;
                    document.getElementById('pendingStatCount').textContent = pendingData.length;
                    renderPendingList();
                }
            } catch (e) {
                console.error('Failed to load pending:', e);
            }
        }

        function renderPendingList() {
            const container = document.getElementById('pendingList');
            if (pendingData.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No pending entries.</p></div>';
                return;
            }
            container.innerHTML = pendingData.map(p => `
                <div class="pending-item" onclick="openReconciliation('${p.id}')">
                    <div class="pending-question">${escapeHtml(String(p.question || '').substring(0, 250))}</div>
                    <div class="pending-answer">‚ûú ${escapeHtml(String(p.answer || '').substring(0, 100))}</div>
                    <div class="pending-meta">
                        <span>üìã ${escapeHtml(p.source || 'Unknown')}</span>
                        <span>üïí ${formatTimeAgo(new Date(p.fetchedAt).getTime())}</span>
                    </div>
                    <div class="pending-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-success btn-sm" onclick="quickApprove('${p.id}')">‚úì Approve</button>
                        <button class="btn btn-primary btn-sm" onclick="openReconciliation('${p.id}')">üîÑ Review</button>
                        <button class="btn btn-danger btn-sm" onclick="quickReject('${p.id}')">‚úó Reject</button>
                    </div>
                </div>
            `).join('');
        }

        async function fetchFromSheets() {
            addLog('Fetching from Google Sheets...', 'info');
            try {
                const result = await apiCall('/api/pending/fetch', 'POST');
                if (result.success) {
                    addLog(`Fetched ${result.data.fetched} entries, added ${result.data.added} new`, 'success');
                    await refreshPending();
                }
            } catch (e) {
                addLog(`Fetch error: ${e.message}`, 'error');
            }
        }

        async function quickApprove(id) {
            try {
                await apiCall(`/api/pending/approve/${id}`, 'POST');
                addLog('Entry approved', 'success');
                await refreshPending();
                await refreshQA();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        async function quickReject(id) {
            if (!confirm('Reject this entry?')) return;
            try {
                await apiCall(`/api/pending/${id}`, 'DELETE');
                addLog('Entry rejected', 'warning');
                await refreshPending();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        async function clearAllPending() {
            if (!confirm('Clear ALL pending entries?')) return;
            try {
                await apiCall('/api/pending', 'DELETE');
                addLog('Cleared all pending', 'warning');
                await refreshPending();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        // Live Mode
        async function checkLiveModeStatus() {
            try {
                const result = await apiCall('/api/pending/live-mode');
                if (result.success) {
                    liveModeEnabled = result.data.enabled;
                    updateLiveModeUI();
                }
            } catch (e) {
                console.error('Failed to check live mode:', e);
            }
        }

        function updateLiveModeUI() {
            document.getElementById('liveModeToggle').checked = liveModeEnabled;
            document.getElementById('liveModeStatus').textContent = liveModeEnabled ? 'ON' : 'OFF';
            document.getElementById('liveModeStatus').style.color = liveModeEnabled ? '#4caf50' : '#888';
            document.getElementById('liveModeNotice').style.display = liveModeEnabled ? 'block' : 'none';
        }

        async function toggleLiveMode() {
            const newState = document.getElementById('liveModeToggle').checked;
            try {
                const result = await apiCall('/api/pending/live-mode', 'POST', { enabled: newState });
                if (result.success) {
                    liveModeEnabled = result.data.enabled;
                    updateLiveModeUI();
                    addLog(`Live Mode ${liveModeEnabled ? 'enabled' : 'disabled'}`, liveModeEnabled ? 'success' : 'info');
                }
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
                document.getElementById('liveModeToggle').checked = liveModeEnabled;
            }
        }

        // Reconciliation
        async function openReconciliation(id) {
            const pending = pendingData.find(p => p.id === id);
            if (!pending) return;
            currentPendingId = id;
            selectedMatchIndex = null;
            document.getElementById('mergeBtn').disabled = true;
            document.getElementById('reconPendingId').value = id;
            document.getElementById('reconQuestion').value = pending.question || '';
            document.getElementById('reconAnswer').value = pending.answer || '';
            document.getElementById('reconSource').textContent = `${pending.source || 'Unknown'}`;
            document.getElementById('reconSearchInput').value = '';
            document.getElementById('reconOptionsContainer').style.display = 'none';
            document.getElementById('reconcileModal').classList.add('active');
            await searchForMatches(pending.question);
        }

        async function searchForMatches(query) {
            const searchQuery = query || document.getElementById('reconSearchInput').value.trim();
            const container = document.getElementById('matchList');
            if (!searchQuery) {
                container.innerHTML = '<div class="no-matches">Enter a search term</div>';
                return;
            }
            container.innerHTML = '<div class="no-matches">Searching...</div>';
            try {
                const result = await apiCall('/api/qa/search', 'POST', { query: searchQuery, threshold: 0.2 });
                if (result.success && result.data.matches.length > 0) {
                    container.innerHTML = result.data.matches.map(m => `
                        <div class="match-item ${selectedMatchIndex === m.index ? 'selected' : ''}" onclick="selectMatch(${m.index}, event)">
                            <div class="match-score">${(m.score * 100).toFixed(0)}% match</div>
                            <div class="match-question">${escapeHtml(m.qa.question?.substring(0, 100) || '')}...</div>
                            <div class="match-answer">‚úì ${escapeHtml(Array.isArray(m.qa.answer) ? m.qa.answer.join(', ') : m.qa.answer?.toString()?.substring(0, 80) || '')}...</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="no-matches">No similar entries found</div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="no-matches">Search error: ${e.message}</div>`;
            }
        }

        function selectMatch(index, event) {
            selectedMatchIndex = index;
            document.getElementById('mergeBtn').disabled = false;
            document.querySelectorAll('#matchList .match-item').forEach(el => el.classList.remove('selected'));
            event.target.closest('.match-item').classList.add('selected');
        }

        async function approveAsPending() {
            const id = document.getElementById('reconPendingId').value;
            const question = document.getElementById('reconQuestion').value.trim();
            const answer = document.getElementById('reconAnswer').value.trim();
            if (!question || !answer) { alert('Please fill in both fields'); return; }
            try {
                await apiCall(`/api/pending/approve/${id}`, 'POST', { question, answer });
                addLog('Entry approved', 'success');
                closeModal('reconcileModal');
                await refreshPending();
                await refreshQA();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        async function mergeWithSelected() {
            if (selectedMatchIndex === null) { alert('Select an entry to merge with'); return; }
            const id = document.getElementById('reconPendingId').value;
            try {
                await apiCall(`/api/pending/merge/${id}`, 'POST', { targetIndex: selectedMatchIndex, mergeMode: 'update' });
                addLog(`Merged with QA #${selectedMatchIndex}`, 'success');
                closeModal('reconcileModal');
                await refreshPending();
                await refreshQA();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        async function rejectPending() {
            const id = document.getElementById('reconPendingId').value;
            if (!confirm('Reject this entry?')) return;
            try {
                await apiCall(`/api/pending/${id}`, 'DELETE');
                addLog('Entry rejected', 'warning');
                closeModal('reconcileModal');
                await refreshPending();
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
            }
        }

        // Config
        async function testServerConnection() {
            addLog('Testing connection...', 'info');
            const online = await checkServerStatus();
            alert(online ? '‚úì Connected to API!' : '‚úó Connection failed');
        }

        // Utilities
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function formatDate(ts) { return ts ? new Date(ts).toLocaleDateString() : 'Never'; }
        function formatTimeAgo(ts) {
            if (!ts) return 'Never';
            const s = Math.floor((Date.now() - ts) / 1000);
            if (s < 60) return `${s}s ago`;
            if (s < 3600) return `${Math.floor(s / 60)}m ago`;
            if (s < 86400) return `${Math.floor(s / 3600)}h ago`;
            return `${Math.floor(s / 86400)}d ago`;
        }
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // Modal close handlers
        document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active')); });
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
    </script>
</body>
</html>
